<!DOCTYPE html>
<meta charset="utf-8">
<title>Spotify Pricing Index</title>
<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
<link href='css/bootstrap.css' rel='stylesheet' type='text/css'>
<style>
    @font-face {
        font-family: 'Montserrat';
        font-style: normal;
        font-weight: 400;
        src: local('Montserrat-Regular'), url('fonts/montserrat-normal.woff') format('woff');
    }
    @font-face {
        font-family: 'Montserrat';
        font-style: normal;
        font-weight: 700;
        src: local('Montserrat-Bold'), url('fonts/montserrat-bold.woff') format('woff');
    }

    html, body {
        margin: 0;
        padding: 0;
        background-color: rgb(18,19,20);
        font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        color: #FFF;
    }

    p {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-weight: 200;
    }

    h1 {
        font-size: 50px;
        line-height: 1;
        text-align: center;
    }

    .bar {
        fill: rgba(133, 187, 35, 1);
    }

    .bar:hover {
        fill: rgb(15, 118, 143);
    }

    .bar:hover text {
        fill: white;
    }

    text {
        fill: rgb(136, 137, 140);
        font-size: 12px;
        font-weight: 100;
        text-transform: uppercase;
    }

    .axis text {
        font-size: 10px;
    }

    .axis path, .axis line {
        fill: none;
    }

    .axis line {
        stroke: rgb(34, 35, 38);
        shape-rendering: crispEdges;
    }

    .axis.y line {
        stroke: rgb(145, 43, 13);
    }

    text.nil {
        font-family: serif;
        font-style: italic;
        font-weight: normal;
        text-transform: none;
    }

    /* Map styling */
    .datamap path {
        stroke: #FFFFFF;
        stroke-width: 1px;
    }

    .datamaps-legend {
        z-index: 1001;
        position: absolute;
        bottom: 50px;
        left: 15px;
    }
    .datamaps-legend dt, .datamaps-legend dd {
        float: left;
    }
    .datamaps-legend dd {
        width: 20px;
    }
    .datamaps-legend dt {
        display: none;
    }
    .datamaps-legend dl:before, .datamaps-legend dl:after {
        float: left;
    }
    .datamaps-legend dl:before, .datamaps-legend dl:after {
        content: "$";
        padding-right: 5px;
    }
    .datamaps-legend dl:after {
        content: "$$$";
        padding-left: 5px;
    }

    .datamaps-hoverover {
        display: none;
    }
    .hoverinfo {
        padding: 4px;
        background-color: rgb(62, 62, 62);
        font-size: 12px;
        color: #bbb;
        border: 1px solid rgb(19, 19, 21);
    }
</style>
<script src="http://d3js.org/d3.v3.min.js"></script>
<!--<script src="/js/d3.v3.min.js"></script>-->
<script src="http://d3js.org/topojson.v1.min.js"></script>
<!--<script src="/js/topojson.v1.min.js"></script>-->
<script src="/js/datamaps.world.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
<!--<script src="/js/lodash.min.js"></script>-->
<script src="/js/tinycolor.js"></script>

<body>
    <div class="container">
        <h1 class="headline">Spotify Premium Index</h1>
    </div>

    <script>
        function calculateHeight(){
            var height = 270 / 649 * window.innerWidth;

            return height;
        }

        var container = d3.select(".container");

        var mapElement = container.append("div")
                .attr("id", "map")
                .attr("style", "position: relative; width: auto; height: " + calculateHeight() + "px" );

        var margin = {top: 10, right: 75, bottom: 10, left: 150},
                width = parseInt(mapElement.style('width')),
                width = width - margin.left - margin.right,
                mapRatio = 1.25,
                height = width * mapRatio - margin.top - margin.bottom;

        var x = d3.scale.linear()
                .range([margin.left, width + margin.left])

        var y = d3.scale.ordinal()
                .rangeRoundBands([0, height], .3);

        var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom")
                .tickFormat(function(d){ return d + "%" })
                .tickSize(height);

        container.append("p")
                .html("Local currency under / over valuation against the dollar, %");

        var svg = container.append("svg")
                .attr("width", width + margin.left + margin.right + 100)
                .attr("height", height + margin.top + margin.bottom);

        function fetchJSONFile(path, callback) {
            var httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState === 4) {
                    if (httpRequest.status === 200 || httpRequest.status === 0) {
                        var data = JSON.parse(httpRequest.responseText);
                        if (callback) callback(data);
                    }
                }
            };
            httpRequest.open('GET', path);
            httpRequest.send();
        }
        fetchJSONFile('/api/', function(countries){
            var base = _.find(countries, {'rel': 'us'});

            countries = _.chain(countries)
                    .reverse()
                    .unique("rel")
                    .map(function(country){
                        country.title = country.title.replace(/ \([^)]*\)/, '');

                        var difference = 100 - base.convertedPrice / country.convertedPrice * 100;
                        country.priceDifference = difference;
                        country.formattedPriceDifference = (Math.round(difference * 100) / 100).toFixed(2);
                        country.formattedConvertedPrice = (Math.round(country.convertedPrice * 100) / 100).toFixed(2);

                        country.class = country.priceDifference < 0 ? "bar negative" : "bar positive";
                        country.class = country.class + ' ' + country.region.toLowerCase() + ' ' + country.countryCode.toLowerCase();

                        return country;
                    })
                    .value();

            x.domain(d3.extent(countries, function(d) { return d.priceDifference; })).nice();
            y.domain(countries.map(function(d) { return d.internationalName; }));

            svg.append("g")
                    .attr("class", "x axis")
                    .call(xAxis)

            svg.append("g")
                    .attr("class", "y axis")
                    .append("line")
                    .attr("x1", x(0))
                    .attr("x2", x(0))
                    .attr("y2", height);

            var bars = svg.selectAll("g.bar")
                    .data(countries)
                    .enter()
                    .append("g")
                    .attr("class", function(d) { return d.class; });

            bars.append("rect")
                    .attr("x", function(d) { return x(Math.min(0, d.priceDifference)); })
                    .attr("y", function(d) { return y(d.internationalName); })
                    .attr("width", function(d) { return Math.abs(x(d.priceDifference) - x(0)); })
                    .attr("height", y.rangeBand());

            var labels = bars.append("svg:text")
                    .attr("class", "label")
                    .attr("x", 0)
                    .attr("y", function(d) { return y(d.internationalName); })
                    .attr("text-anchor", "left")
                    .text(function(d) { return d.internationalName; });
            labels.attr("transform", function(d) { return "translate(0, " + (y.rangeBand()/2 + getBoundaryHeight(labels)/4) + ")"; });

            var nil = svg.selectAll("g.bar." + base.countryCode.toLowerCase())
                    .append("svg:text")
                    .attr("class", "nil")
                    .attr("x", x(0))
                    .attr("y", y(base.internationalName))
                    .text("nil");
            nil.attr("transform", function(d) { return "translate(2, " + (y.rangeBand()/2 + getBoundaryHeight(nil)/4) + ")"; });

            var prices = bars.append("svg:text")
                    .attr("class", "price")
                    .attr("x", width + margin.left + margin.right)
                    .attr("y", function(d) { return y(d.internationalName); })
                    .attr("text-anchor", "left")
                    .text(function(d) { return d.formattedConvertedPrice; });
            prices.attr("transform", function(d) { return "translate(-" + getBoundaryWidth(prices) + ", " + (y.rangeBand()/2 + getBoundaryHeight(prices)/4) + ")"; });

            var priceDefinition = svg.append("svg:text")
                    .attr("class", "price-definition visible-md visible-lg")
                    .attr("x", width + margin.left + margin.right)
                    .attr("y", height)
                    .attr("text-anchor", "left")
                    .text("Spotify Premium price*, $");
            priceDefinition.attr("transform", function(d) { return "translate(-" + getBoundaryWidth(priceDefinition) + ", -" + getBoundaryHeight(priceDefinition) + ")"; });

            function getBoundaryHeight(elements){
                return elements.node().getBBox().height;
            }
            function getBoundaryWidth(elements){
                return elements.node().getBBox().width;
            }


            var baseColor = "rgba(133, 187, 35, 1)";
            var ratio = 20;
            var fills = {
                LOWEST: tinycolor.lighten(baseColor, ratio).toHexString(),
                LOW: tinycolor.lighten(baseColor, ratio/2).toHexString(),
                AVERAGE: tinycolor(baseColor).toHexString(),
                HIGH: tinycolor.darken(baseColor, ratio/2).toHexString(),
                HIGHEST: tinycolor.darken(baseColor, ratio).toHexString(),
                defaultFill: 'rgba(255, 255, 255, .1)'
            };

            var map = new Datamap({
                element: document.getElementById('map'),
                fills: fills,
                projection: 'equirectangular', //"mercator"/"equirectangular"
                done: updateMapColors,
                disableDefaultStyles: true,
                geographyConfig: {
                    hideAntarctica: true,
                    borderWidth: 0,
                    popupTemplate: function(geography, data) {
                        if(!data)
                            return;

                        return '<div class="hoverinfo"><strong>' + data.internationalName + ':</strong> $' + data.convertedPrice + '</div>';
                    },
                    popupOnHover: true,
                    highlightOnHover: true,
                    highlightFillColor: function(geography, data){
                        if(!data)
                            return fills.defaultFill;

                        return 'rgba(255, 255, 255, .9)';
                    },
                    highlightBorderWidth: 0
                }
            });

            map.legend();

            function updateMapColors(map){
                var sortedDifferences = _.map(_.sortBy(countries, 'priceDifference'), function(country){
                    return country.priceDifference;
                });
                var quantile = [
                    d3.quantile(sortedDifferences, 0.2),
                    d3.quantile(sortedDifferences, 0.4),
                    d3.quantile(sortedDifferences, 0.6),
                    d3.quantile(sortedDifferences, 0.8)
                ];
                var update = {};
                _.each(countries, function(country){
                    update[country.countryCode] = {
                        fillKey: calculateColor(country.priceDifference),
                        internationalName: country.internationalName,
                        priceDifference: country.formattedPriceDifference,
                        convertedPrice: country.formattedConvertedPrice
                    };
                });
                map.updateChoropleth(update);

                function calculateColor(diff){
                    var color;
                    if(diff <= quantile[0])
                        color = 'LOWEST';

                    if(diff > quantile[0])
                        color = 'LOW';

                    if(diff > quantile[1] && diff < quantile[2])
                        color = 'AVERAGE';

                    if(diff > quantile[2])
                        color = 'HIGH';

                    if(diff >= quantile[3])
                        color = 'HIGHEST';

                    return color;
                }
            }
        });
    </script>
</body>